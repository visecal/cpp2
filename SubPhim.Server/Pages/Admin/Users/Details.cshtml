@page "{id:int}"
@model SubPhim.Server.Pages.Admin.Users.DetailsModel

@{
    ViewData["Title"] = "Chi tiết User: " + Model.User.Username;
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
    var allFeatures = Enum.GetValues(typeof(SubPhim.Server.Data.GrantedFeatures))
                          .Cast<SubPhim.Server.Data.GrantedFeatures>()
                          .Where(f => f != SubPhim.Server.Data.GrantedFeatures.None);
    var allApis = Enum.GetValues(typeof(SubPhim.Server.Data.AllowedApis))
                      .Cast<SubPhim.Server.Data.AllowedApis>()
                      .Where(a => a != SubPhim.Server.Data.AllowedApis.None);
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}


<h1>@ViewData["Title"]</h1>
<hr />

<div class="row">
    <!-- CỘT TRÁI - THÔNG TIN CHÍNH -->
    <div class="col-md-8">
        <form method="post" asp-page-handler="Save">
            <input type="hidden" asp-for="User.Id" />

            <div class="card mb-4">
                <div class="card-header">Thông tin tài khoản & Giới hạn</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input class="form-control" asp-for="User.Username" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="User.Uid"></label>
                        <input class="form-control" asp-for="User.Uid" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="User.Email"></label>
                        <input class="form-control" asp-for="User.Email" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="User.Tier">Gói thuê bao</label>
                        <select id="tierSelector" class="form-select" asp-for="User.Tier" asp-items="Html.GetEnumSelectList<SubPhim.Server.Data.SubscriptionTier>()"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="User_SubscriptionExpiry">Ngày hết hạn</label>
                        <input id="expiryDateInput" type="datetime-local" class="form-control"
                               name="User.SubscriptionExpiry"
                               value="@(Model.User.SubscriptionExpiry?.ToString("yyyy-MM-ddTHH:mm"))" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="User.MaxDevices">Giới hạn thiết bị</label>
                        <input type="number" class="form-control" asp-for="User.MaxDevices" />
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" asp-for="User.IsBlocked">
                        <label class="form-check-label" asp-for="User.IsBlocked">Chặn tài khoản này (Block)</label>
                    </div>
                    <hr />
                    <h6 class="text-muted">Giới hạn Xử lý Video</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" asp-for="User.VideoDurationLimitMinutes"></label>
                            <input type="number" class="form-control" asp-for="User.VideoDurationLimitMinutes" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" asp-for="User.DailyVideoLimit"></label>
                            <input type="number" class="form-control" asp-for="User.DailyVideoLimit" />
                            <div class="form-text">Nhập -1 để không giới hạn.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="User.VideosProcessedToday"></label>
                        <input type="number" class="form-control" asp-for="User.VideosProcessedToday" />
                    </div>
                    <hr />
                    <h6 class="text-muted">Giới hạn Dịch Thuật & TTS</h6>
                    <div class="mb-3">
                        <label class="form-label" asp-for="User.DailyRequestLimitOverride"></label>
                        <input type="number" class="form-control" asp-for="User.DailyRequestLimitOverride" />
                        <div class="form-text">Nhập -1 để dùng mặc định theo gói. Gói Free mặc định là 50, các gói trả phí mặc định là không giới hạn.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" asp-for="User.DailySrtLineLimit"></label>
                            <input type="number" class="form-control" asp-for="User.DailySrtLineLimit" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" asp-for="User.SrtLinesUsedToday"></label>
                            <input type="number" class="form-control" asp-for="User.SrtLinesUsedToday" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" asp-for="User.TtsCharacterLimit"></label>
                            <input type="number" class="form-control" asp-for="User.TtsCharacterLimit" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" asp-for="User.TtsCharactersUsed"></label>
                            <input type="number" class="form-control" asp-for="User.TtsCharactersUsed" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">Kiểm soát API Được Phép</div>
                <div class="card-body">
                    <p class="text-muted small">Nếu không chọn gì, hệ thống sẽ tự áp dụng quyền mặc định theo Gói thuê bao.</p>
                    <div class="row">
                        @foreach (var api in allApis)
                        {
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="allowedApis" value="@api"
                                           id="api-@api" @(Model.User.AllowedApiAccess.HasFlag(api) ? "checked" : "")>
                                    <label class="form-check-label" for="api-@api">@api.ToString()</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">Quyền Truy Cập Tính Năng</div>
                <div class="card-body">
                    <div class="row">
                        @foreach (var feature in allFeatures)
                        {
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="features" value="@feature"
                                           id="feature-@feature" @(Model.User.GrantedFeatures.HasFlag(feature) ? "checked" : "")>
                                    <label class="form-check-label" for="feature-@feature">@feature</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save"></i> Lưu Thay Đổi</button>
                <a asp-page="./Index" class="btn btn-secondary btn-lg">Quay lại danh sách</a>
            </div>
        </form>

        <div class="card mt-4">
            <div class="card-header">Các thiết bị đã đăng nhập (@Model.User.Devices.Count)</div>
            <div class="card-body p-0">
                @if (Model.User.Devices.Any())
                {
                    <table class="table table-striped table-hover mb-0">
                        <thead><tr><th>HWID</th><th>IP cuối</th><th>Lần cuối đăng nhập</th></tr></thead>
                        <tbody>
                            @foreach (var device in Model.User.Devices.OrderByDescending(d => d.LastLogin))
                            {
                                <tr>
                                    <td><code>@device.Hwid</code></td>
                                    <td><code>@device.LastLoginIp</code></td>
                                    <td>@(device.LastLogin.ToVietNamTimeString("g"))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-center text-muted p-3 mb-0">Người dùng này chưa đăng nhập trên thiết bị nào.</p>
                }
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Thao Tác Nhanh</div>
            <div class="card-body">
                <form method="post" asp-page-handler="AddSubTime" asp-route-id="@Model.User.Id" class="mb-4">
                    <label class="form-label" asp-for="DaysToAdd"></label>
                    <div class="input-group">
                        <input type="number" asp-for="DaysToAdd" class="form-control" />
                        <button type="submit" class="btn btn-success">Thêm</button>
                    </div>
                </form>
                <hr />
                <form method="post" asp-page-handler="SubtractSubTime" asp-route-id="@Model.User.Id" class="mb-4"
                      onsubmit="return confirm('CẢNH BÁO!\nHành động này sẽ TRỪ đi số ngày sử dụng của tài khoản này.\n\nBạn có chắc chắn muốn tiếp tục?');">
                    <label class="form-label">Số ngày muốn trừ</label>
                    <div class="input-group">
                        <input type="number" name="DaysToAdd" value="30" class="form-control" />
                        <button type="submit" class="btn btn-warning">Trừ</button>
                    </div>
                </form>
                <hr />
                <form method="post" asp-page-handler="ResetPassword" asp-route-id="@Model.User.Id" class="mb-4">
                    <label class="form-label" asp-for="NewPassword"></label>
                    <div class="input-group">
                        <input type="text" asp-for="NewPassword" class="form-control" placeholder="Nhập pass mới..." />
                        <button type="submit" class="btn btn-warning">Reset</button>
                    </div>
                </form>
                <hr />
                <div class="d-grid gap-2">
                    <form method="post" asp-page-handler="BanUser" asp-route-id="@Model.User.Id"
                          onsubmit="return confirm('CẢNH BÁO!\nHành động này sẽ CHẶN tài khoản và CẤM TẤT CẢ các thiết bị đã đăng nhập của người dùng này.\n\nBạn có chắc chắn muốn tiếp tục?');">
                        <button type="submit" class="btn btn-warning w-100 fw-bold">
                            <i class="bi bi-shield-slash-fill"></i> Cấm (Ban) Tài Khoản & Thiết Bị
                        </button>
                    </form>
                    <form method="post" asp-page-handler="ResetDevices" asp-route-id="@Model.User.Id" onsubmit="return confirm('Bạn có chắc chắn muốn XÓA TOÀN BỘ thiết bị của user này?');">
                        <button type="submit" class="btn btn-info w-100"><i class="bi bi-hdd-stack-fill"></i> Reset Thiết Bị</button>
                    </form>
                    <form method="post" asp-page-handler="DeleteUser" asp-route-id="@Model.User.Id" onsubmit="return confirm('CẢNH BÁO!!!\nHành động này không thể hoàn tác.\nBạn có thực sự muốn XÓA VĨNH VIỄN user này?');">
                        <button type="submit" class="btn btn-danger w-100"><i class="bi bi-trash-fill"></i> Xóa Tài Khoản</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tierSelector = document.getElementById('tierSelector');
            const expiryDateInput = document.getElementById('expiryDateInput');
            async function applyTierDefaultsOnDetailsPage(tier) {
                try {
                    const response = await fetch(`/Admin/Users?handler=TierDefaults&tier=${tier}`);
                    if (!response.ok) {
                        alert('Không thể tải cài đặt mặc định cho gói này.');
                        return;
                    }
                    const data = await response.json();
                    document.querySelector('[name="User.DailyVideoLimit"]').value = data.dailyVideoCount;
                    document.querySelector('[name="User.DailyRequestLimitOverride"]').value = data.dailyTranslationRequests;
                    document.querySelector('[name="User.DailySrtLineLimit"]').value = data.dailySrtLineLimit;
                    //document.querySelector('[name="User.DailyLocalSrtLimit"]').value = data.dailyLocalSrtLimit;

                    document.querySelectorAll('input[name="allowedApis"]').forEach(checkbox => {
                        checkbox.checked = data.allowedApis.includes(checkbox.value);
                    });
                    document.querySelectorAll('input[name="features"]').forEach(checkbox => {
                        checkbox.checked = data.grantedFeatures.includes(checkbox.value);
                    });

                } catch (error) {
                    alert('Lỗi kết nối khi lấy cài đặt mặc định.');
                    console.error("Fetch tier defaults error:", error);
                }
            }

            if (tierSelector) {
                tierSelector.addEventListener('change', function (event) {
                    expiryDateInput.readOnly = false;
                    applyTierDefaultsOnDetailsPage(event.target.value);
                });
            }
        });
    </script>
}