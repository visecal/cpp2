@page
@model SubPhim.Server.Pages.Admin.VipTranslation.ExternalApiKeysModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω External API Keys";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>@Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-key me-2"></i>@ViewData["Title"]</h1>
        <p class="text-muted">Qu·∫£n l√Ω API keys cho kh√°ch h√†ng b√™n ngo√†i s·ª≠ d·ª•ng d·ªãch v·ª• VIP Translation</p>
    </div>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
        <i class="bi bi-plus-circle me-2"></i>T·∫°o API Key m·ªõi
    </button>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="keys-tab" data-bs-toggle="tab" data-bs-target="#keys" type="button">
            <i class="bi bi-key me-2"></i>API Keys (@Model.ApiKeys.Count)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" type="button">
            <i class="bi bi-graph-up me-2"></i>L·ªãch s·ª≠ s·ª≠ d·ª•ng
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
            <i class="bi bi-gear me-2"></i>C√†i ƒë·∫∑t h·ªá th·ªëng
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
    <!-- API Keys Tab -->
    <div class="tab-pane fade show active" id="keys" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Key ID</th>
                                <th>T√™n hi·ªÉn th·ªã</th>
                                <th>G√°n cho</th>
                                <th>Credit</th>
                                <th>RPM</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.ApiKeys.Any())
                            {
                                @foreach (var key in Model.ApiKeys)
                                {
                                    <tr>
                                        <td><code>@key.KeyPrefix...@key.KeySuffix</code></td>
                                        <td>@(key.DisplayName ?? "-")</td>
                                        <td>@(key.AssignedTo ?? "-")</td>
                                        <td>
                                            <span class="badge @(key.CreditBalance > 1000 ? "bg-success" : key.CreditBalance > 0 ? "bg-warning" : "bg-danger")">
                                                @key.CreditBalance.ToString("N0")
                                            </span>
                                        </td>
                                        <td>@key.RpmLimit</td>
                                        <td>@key.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @if (key.IsEnabled)
                                            {
                                                <span class="badge bg-success">‚úÖ Active</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">‚õî Disabled</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        onclick="viewApiKey(@key.Id)">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-success" 
                                                        onclick="addCredits(@key.Id)">
                                                    <i class="bi bi-cash-coin"></i>
                                                </button>
                                                @if (key.IsEnabled)
                                                {
                                                    <form method="post" asp-page-handler="DisableKey" asp-route-id="@key.Id" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-outline-warning" 
                                                                onclick="return confirm('V√¥ hi·ªáu h√≥a API key n√†y?')">
                                                            <i class="bi bi-slash-circle"></i>
                                                        </button>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <form method="post" asp-page-handler="EnableKey" asp-route-id="@key.Id" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-outline-success" 
                                                                onclick="return confirm('K√≠ch ho·∫°t API key n√†y?')">
                                                            <i class="bi bi-check-circle"></i>
                                                        </button>
                                                    </form>
                                                }
                                                <form method="post" asp-page-handler="DeleteKey" asp-route-id="@key.Id" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-outline-danger" 
                                                            onclick="return confirm('X√≥a vƒ©nh vi·ªÖn API key n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                        Ch∆∞a c√≥ API key n√†o. Nh·∫•n "T·∫°o API Key m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage History Tab -->
    <div class="tab-pane fade" id="usage" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">L·ªãch s·ª≠ s·ª≠ d·ª•ng</h5>
                <p class="text-muted">Ch·ª©c nƒÉng n√†y ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. S·∫Ω hi·ªÉn th·ªã l·ªãch s·ª≠ s·ª≠ d·ª•ng chi ti·∫øt c·ªßa t·∫•t c·∫£ API keys.</p>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="card">
            <div class="card-header"><strong>‚öôÔ∏è C√†i ƒë·∫∑t External API</strong></div>
            <div class="card-body">
                <form method="post" asp-page-handler="UpdateSettings">
                    @Html.AntiForgeryToken()
                    
                    <h6 class="mb-3"><i class="bi bi-cash-stack me-2"></i>Quy ƒë·ªïi Credit</h6>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label asp-for="Settings.CreditsPerCharacter" class="form-label">Credit/K√Ω t·ª±</label>
                            <input asp-for="Settings.CreditsPerCharacter" class="form-control" type="number" min="1" />
                            <small class="form-text text-muted">S·ªë credit t√≠nh cho 1 k√Ω t·ª± output</small>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="Settings.VndPerCredit" class="form-label">VND/Credit</label>
                            <input asp-for="Settings.VndPerCredit" class="form-control" type="number" step="0.01" min="0.01" />
                            <small class="form-text text-muted">Gi√° VND cho 1 credit</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">V√≠ d·ª• quy ƒë·ªïi</label>
                            <div class="p-2 bg-light rounded">
                                <span id="conversionExample">1,000 k√Ω t·ª± = 5,000 credits = 50,000 VND</span>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-3"><i class="bi bi-speedometer me-2"></i>M·∫∑c ƒë·ªãnh cho API Key m·ªõi</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label asp-for="Settings.DefaultRpm" class="form-label">RPM m·∫∑c ƒë·ªãnh</label>
                            <input asp-for="Settings.DefaultRpm" class="form-control" type="number" min="1" />
                            <small class="form-text text-muted">Requests per minute cho API key m·ªõi</small>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Settings.DefaultInitialCredits" class="form-label">Credit kh·ªüi t·∫°o</label>
                            <input asp-for="Settings.DefaultInitialCredits" class="form-control" type="number" min="0" />
                            <small class="form-text text-muted">S·ªë credit ban ƒë·∫ßu khi t·∫°o API key m·ªõi</small>
                        </div>
                    </div>

                    <h6 class="mb-3"><i class="bi bi-calculator me-2"></i>M√°y t√≠nh quy ƒë·ªïi</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nh·∫≠p s·ªë k√Ω t·ª±</label>
                            <input type="number" id="charInput" class="form-control" placeholder="10000" />
                            <small class="form-text text-muted" id="charResult">‚Üí ? credits ‚Üí ? VND</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nh·∫≠p s·ªë ti·ªÅn VND</label>
                            <input type="number" id="vndInput" class="form-control" placeholder="1000000" />
                            <small class="form-text text-muted" id="vndResult">‚Üí ? credits ‚Üí ? k√Ω t·ª±</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>L∆∞u c√†i ƒë·∫∑t
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateKey">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>T·∫°o External API Key m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">T√™n hi·ªÉn th·ªã</label>
                        <input type="text" name="DisplayName" class="form-control" placeholder="VD: Client ABC" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">G√°n cho</label>
                        <input type="text" name="AssignedTo" class="form-control" placeholder="VD: C√¥ng ty XYZ" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="Email" class="form-control" placeholder="client@example.com" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea name="Notes" class="form-control" rows="2" placeholder="Ghi ch√∫ n·ªôi b·ªô"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">RPM Limit</label>
                            <input type="number" name="RpmLimit" class="form-control" value="@Model.Settings.DefaultRpm" min="1" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Credit kh·ªüi t·∫°o</label>
                            <input type="number" name="InitialCredits" class="form-control" value="@Model.Settings.DefaultInitialCredits" min="0" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-key me-2"></i>T·∫°o API Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- API Key Created Success Modal -->
@if (!string.IsNullOrEmpty(Model.NewApiKey))
{
    <div class="modal fade" id="keyCreatedModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>API Key ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>QUAN TR·ªåNG:</strong> Sao ch√©p API key n√†y ngay b√¢y gi·ªù. B·∫°n s·∫Ω KH√îNG TH·ªÇ xem l·∫°i key ƒë·∫ßy ƒë·ªß sau khi ƒë√≥ng dialog n√†y!
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>üîë API Key:</strong></label>
                        <div class="input-group">
                            <input type="text" id="newApiKeyInput" class="form-control font-monospace" value="@Model.NewApiKey" readonly />
                            <button class="btn btn-outline-secondary" type="button" onclick="copyApiKey()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>
                    <div id="copySuccess" class="alert alert-success d-none">
                        <i class="bi bi-check-circle me-2"></i>API key ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check-lg me-2"></i>ƒê√£ sao ch√©p
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Credits Modal -->
<div class="modal fade" id="addCreditsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="AddCredits" id="addCreditsForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ApiKeyId" id="addCreditsApiKeyId" />
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i>N·∫°p Credit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">S·ªë l∆∞·ª£ng Credit</label>
                        <input type="number" name="Amount" class="form-control" min="1" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£</label>
                        <input type="text" name="Description" class="form-control" placeholder="VD: N·∫°p credit th√°ng 12" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-2"></i>N·∫°p Credit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Show new API key modal if key was created
        @if (!string.IsNullOrEmpty(Model.NewApiKey))
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
                var modal = new bootstrap.Modal(document.getElementById('keyCreatedModal'));
                modal.show();
            });
            </text>
        }

        function copyApiKey() {
            var input = document.getElementById('newApiKeyInput');
            input.select();
            document.execCommand('copy');
            document.getElementById('copySuccess').classList.remove('d-none');
        }

        function addCredits(apiKeyId) {
            document.getElementById('addCreditsApiKeyId').value = apiKeyId;
            var modal = new bootstrap.Modal(document.getElementById('addCreditsModal'));
            modal.show();
        }

        function viewApiKey(apiKeyId) {
            // Navigate to detail page (to be implemented)
            window.location.href = `/Admin/VipTranslation/ExternalApiKeyDetail?id=${apiKeyId}`;
        }

        // Calculator functionality
        document.getElementById('charInput')?.addEventListener('input', function(e) {
            var chars = parseInt(e.target.value) || 0;
            var creditsPerChar = parseInt(document.querySelector('[name="Settings.CreditsPerCharacter"]').value) || 5;
            var vndPerCredit = parseFloat(document.querySelector('[name="Settings.VndPerCredit"]').value) || 10;
            var credits = chars * creditsPerChar;
            var vnd = credits * vndPerCredit;
            document.getElementById('charResult').textContent = `‚Üí ${credits.toLocaleString()} credits ‚Üí ${vnd.toLocaleString()} VND`;
        });

        document.getElementById('vndInput')?.addEventListener('input', function(e) {
            var vnd = parseInt(e.target.value) || 0;
            var creditsPerChar = parseInt(document.querySelector('[name="Settings.CreditsPerCharacter"]').value) || 5;
            var vndPerCredit = parseFloat(document.querySelector('[name="Settings.VndPerCredit"]').value) || 10;
            var credits = vnd / vndPerCredit;
            var chars = credits / creditsPerChar;
            document.getElementById('vndResult').textContent = `‚Üí ${credits.toLocaleString()} credits ‚Üí ${Math.floor(chars).toLocaleString()} k√Ω t·ª±`;
        });

        // Update conversion example
        function updateConversionExample() {
            var creditsPerChar = parseInt(document.querySelector('[name="Settings.CreditsPerCharacter"]').value) || 5;
            var vndPerCredit = parseFloat(document.querySelector('[name="Settings.VndPerCredit"]').value) || 10;
            var chars = 1000;
            var credits = chars * creditsPerChar;
            var vnd = credits * vndPerCredit;
            document.getElementById('conversionExample').textContent = 
                `${chars.toLocaleString()} k√Ω t·ª± = ${credits.toLocaleString()} credits = ${vnd.toLocaleString()} VND`;
        }

        document.querySelector('[name="Settings.CreditsPerCharacter"]')?.addEventListener('input', updateConversionExample);
        document.querySelector('[name="Settings.VndPerCredit"]')?.addEventListener('input', updateConversionExample);
    </script>
}
